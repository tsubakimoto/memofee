---
description: 'C# アプリケーション構築のためのガイドライン'
applyTo: '**/*.cs'
---

# C# 開発

## C# の指針
- 常に最新の C# を使用します。現在は C# 13 の機能を想定します。
- 各関数には明確で簡潔なコメントを記載します。

## 一般的な指針
- コードレビューでは、確信度の高い提案のみを行います。
- 保守性を意識したコードを書き、なぜその設計判断に至ったかをコメントで残します。
- エッジケースに対応し、明確な例外処理を記述します。
- ライブラリや外部依存を使用する場合は、用途と目的をコメントで示します。

## 命名規則

- コンポーネント名、メソッド名、パブリックメンバーには PascalCase を使用します。
- プライベートフィールドやローカル変数には camelCase を使用します。
- インターフェイス名には「I」を接頭辞として付けます（例: IUserService）。

## フォーマット

- `.editorconfig` に定義されたコード整形スタイルを適用します。
- ファイルスコープの名前空間宣言と単一行の using ディレクティブを推奨します。
- すべてのコードブロック（if、for、while、foreach、using、try など）の開き波括弧の直前に改行を入れます。
- メソッドの最終 return 文は独立した行に配置します。
- 可能な限りパターンマッチングや switch 式を使用します。
- メンバー名を参照する際は文字列リテラルではなく `nameof` を使用します。
- すべてのパブリック API には XML ドキュメントコメントを作成します。可能であれば `<example>` や `<code>` の記載も行います。

## プロジェクトのセットアップと構成

- 適切なテンプレートを用いた .NET プロジェクトの新規作成を案内します。
- 生成された各ファイルやフォルダーの役割を説明し、プロジェクト構造の理解を促します。
- フィーチャーフォルダーや DDD の原則を用いたコードの整理方法を示します。
- モデル、サービス、データアクセス層の関心の分離を適切に行います。
- ASP.NET Core 9 における Program.cs と構成システム、環境別設定について説明します。

## Null 許容参照型

- 変数は非 null を前提に宣言し、エントリポイントで `null` をチェックします。
- `== null` や `!= null` ではなく、常に `is null` または `is not null` を使用します。
- C# の null アノテーションを信頼し、型システムが非 null と保証する値に不要な null チェックを追加しません。

## データアクセスパターン

- Entity Framework Core を用いたデータアクセス層の実装を案内します。
- 開発・本番における選択肢（SQL Server、SQLite、In-Memory）を説明します。
- リポジトリパターンの実装方法と有効な場面を示します。
- データベースマイグレーションとデータシーディングの実装方法を示します。
- 典型的なパフォーマンス問題を避ける効率的なクエリパターンを説明します。

## 認証と認可

- JWT Bearer トークンを用いた認証の実装を案内します。
- ASP.NET Core における OAuth 2.0 と OpenID Connect の概念を説明します。
- ロールベースおよびポリシーベースの認可の実装方法を示します。
- Microsoft Entra ID（旧 Azure AD）との統合を例示します。
- コントローラーベースと Minimal API の双方で一貫した保護を行う方法を説明します。

## 検証とエラーハンドリング

- データアノテーションおよび FluentValidation を用いたモデル検証の実装を案内します。
- 検証パイプラインと、検証応答のカスタマイズ方法を説明します。
- ミドルウェアを用いたグローバル例外処理戦略を示します。
- API 全体で一貫したエラーレスポンスを作成する方法を示します。
- 標準化されたエラー応答のための Problem Details（RFC 7807）の実装を説明します。

## API バージョニングとドキュメント

- API バージョニング戦略の実装と解説を行います。
- Swagger/OpenAPI を用いた適切なドキュメント化を例示します。
- エンドポイント、パラメーター、応答、認証の記述方法を示します。
- コントローラーベースと Minimal API の双方でのバージョニング手法を説明します。
- 利用者に有用な API ドキュメントの作成を指南します。

## ロギングと監視

- Serilog などのプロバイダーを用いた構造化ロギングの実装を案内します。
- ログレベルの意味と使い分けを説明します。
- テレメトリ収集のための Application Insights との統合を例示します。
- リクエスト追跡のためのカスタムテレメトリと相関 ID の実装方法を示します。
- API のパフォーマンス、エラー、利用状況の監視方法を説明します。

## テスト

- アプリケーションのクリティカルパスには必ずテストケースを含めます。
- 単体テストの作成方法を案内します。
- "Act"、"Arrange"、"Assert" のコメントは出力しません。
- 既存ファイルのスタイルに合わせてテストメソッド名と大文字小文字を統一します。
- API エンドポイントの結合テスト手法を説明します。
- 依存関係のモックによる効果的なテスト方法を示します。
- 認証・認可ロジックのテスト方法を示します。
- API 開発における TDD の原則を説明します。

## パフォーマンス最適化

- キャッシュ戦略（インメモリ、分散、レスポンスキャッシュ）の実装を案内します。
- 非同期プログラミングパターンと、API パフォーマンスにおける重要性を説明します。
- 大規模データに対するページング、フィルタリング、ソートを例示します。
- 圧縮などのパフォーマンス最適化の実装方法を示します。
- API パフォーマンスの計測とベンチマーク方法を説明します。

## デプロイと DevOps

- .NET の組み込みコンテナサポートを用いた API のコンテナ化を案内します（`dotnet publish --os linux --arch x64 -p:PublishProfile=DefaultContainer`）。
- 手書きの Dockerfile と .NET のコンテナ発行機能の違いを説明します。
- .NET アプリケーション向け CI/CD パイプラインを説明します。
- Azure App Service、Azure Container Apps などへのデプロイ方法を例示します。
- ヘルスチェックや Readiness Probe の実装方法を示します。
- デプロイ段階ごとの環境別構成の考え方を説明します。
