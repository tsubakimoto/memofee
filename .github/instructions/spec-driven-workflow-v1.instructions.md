---
description: '仕様駆動型ワークフロー v1 は、ソフトウェア開発に対する構造化されたアプローチを提供し、要件が明確に定義され、設計が綿密に計画され、実装が徹底的に文書化および検証されることを保証します。'
applyTo: '**'
---
# 仕様駆動ワークフロー v1

**仕様駆動ワークフロー:**
要件と実装の間のギャップを埋める。

**常に以下の成果物を維持する:**
- **`requirements.md`**: 構造化されたEARS表記によるユーザーストーリーと受け入れ基準。
- **`design.md`**: 技術アーキテクチャ、シーケンス図、実装上の考慮事項。
- **`tasks.md`**: 詳細かつ追跡可能な実装計画。

## ユニバーサルドキュメントフレームワーク

**ドキュメントルール:**
詳細テンプレートを全ドキュメントの**主要な情報源**として使用する。

**要約フォーマット:**
変更履歴やプルリクエストの説明など簡潔なアーティファクトにのみ使用する。

### 詳細ドキュメントテンプレート

#### アクションドキュメントテンプレート (全ステップ/実行/テスト)

```bash
### [タイプ] - [アクション] - [タイムスタンプ]
**目的**: [達成される目標]
**背景**: [現状、要件、および先行ステップへの参照]
**決定**: [選択したアプローチと根拠、該当する場合は決定記録を参照]
**実行**: [使用したパラメータとコマンドを含む実施手順。コードの場合はファイルパスを含める]
**出力**: [完全かつ省略なしの結果、ログ、コマンド出力、メトリクス]
**検証**: [成功確認方法と結果。失敗した場合は修正計画を含める]
**次**: [次の特定アクションへの自動継続計画]
```

#### 決定記録テンプレート（全決定対象）

```bash
### 決定 - [タイムスタンプ]
**決定内容**: [決定事項]
**背景**: [決定を必要とした状況と根拠データ]
**選択肢**: [評価した代替案と簡潔な長所・短所]
**理由**: [選定案が優れている根拠と明示的なトレードオフ]
**影響**: [実装・保守性・パフォーマンスへの予測される結果]
**レビュー**: [本決定の再評価条件またはスケジュール]
```

### 報告用サマリー形式

#### 簡略化アクションログ

簡潔な変更履歴生成用。各ログ項目は完全なアクション文書から抽出。

`[タイプ][タイムスタンプ] 目標: [X] → アクション: [Y] → 結果: [Z] → 次工程: [W]`

#### 圧縮決定記録

プルリクエスト要約やエグゼクティブサマリーで使用。

`決定: [X] | 根拠: [Y] | 影響: [Z] | レビュー: [日付]`

## 実行ワークフロー（6段階ループ）

**いかなるステップも省略しない。用語を統一する。曖昧さを減らす。**

### **フェーズ1: 分析**

**目的:**

- 問題を理解する。
- 既存システムを分析する。
- 明確でテスト可能な要件セットを作成する。
- 可能な解決策とその影響について検討する。

**チェックリスト:**

- [ ] 提供された全コード、ドキュメント、テスト、ログを読む。
    - ファイル一覧、要約、初期分析結果を文書化する。
- [ ] 要件を**EARS表記法**で定義する:
    - 機能要求を構造化されたテスト可能な要件に変換する。
    - 形式: `WHEN [条件またはイベントが発生した場合], THE SYSTEM SHALL [期待される動作]`
- [ ] 依存関係と制約を特定する。
    - リスクと緩和策を含む依存関係グラフを文書化する。
- [ ] データフローと相互作用をマッピングする。
    - システム相互作用図とデータモデルを文書化する。
- [ ] エッジケースと障害をカタログ化する。
    - 包括的なエッジケースマトリクスと潜在的な障害点を文書化する。
- [ ] 信頼度を評価する。
    - 要件の明確さ、複雑さ、問題範囲に基づき**信頼度スコア（0-100%）**を生成する。
    - スコアとその根拠を文書化する。

**重要制約事項:**

- **全ての要件が明確化され文書化されるまで、次の段階に進んではならない。**

### **フェーズ2: 設計**

**目的:**

- 包括的な技術設計と詳細な実装計画を作成する。

**チェックリスト:**

- [ ] **信頼度スコアに基づく適応的実行戦略を定義:**
  - **高信頼度 (>85%)**
    - 包括的な段階的実装計画を草案化する。
    - 概念実証（PoC）ステップを省略する。
    - 完全自動化された実装を推進する。
    - 標準的な包括的ドキュメントを維持する。
  - **中程度の信頼度 (66–85%)**
    - **概念実証 (PoC)** または **最小限の実行可能製品 (MVP)** を優先する。
    - PoC/MVP の明確な成功基準を定義する。
    - まず PoC/MVP を構築・検証し、計画を段階的に拡大する。
    - PoC/MVPの目標、実行内容、検証結果を文書化する。
  - **信頼度低（<66%）**
    - 最初のフェーズを調査と知識構築に充てる。
    - 意味検索を活用し、類似実装を分析する。
    - 調査結果を研究文書にまとめる。
    - 調査後、ANALYZEフェーズを再実行する。
    - 信頼度が低い場合のみエスカレーションする。

- [ ] **技術設計を`design.md`に文書化:**
  - **アーキテクチャ:** コンポーネントと相互作用の高レベル概要。
  - **データフロー:** 図解と説明。
  - **インターフェース:** API契約、スキーマ、公開関数シグネチャ。
  - **データモデル:** データ構造とデータベーススキーマ。

- [ ] **エラー処理の文書化:
  - 手順と想定応答を記載したエラーマトリックスを作成。

- [ ] **ユニットテスト戦略の定義。

- [ ] **`tasks.md`に実装計画を作成:
  - 各タスクに説明、期待される成果、依存関係を含める。

**重要制約:**

- **設計と計画が完了し検証されるまで実装に進んではならない。**

### **フェーズ3: 実装**

**目的:**

- 設計と計画に基づき、本番環境品質のコードを記述する。

**チェックリスト:**

- [ ] テスト可能な小さな単位でコードを記述する。
      - 各単位ごとにコード変更内容、結果、テストリンクを文書化する。
- [ ] 依存関係を上流から実装する。
      - 解決順序、根拠、検証を文書化する。
- [ ] 規約に従う。
      - 準拠状況と逸脱事項を決定記録で文書化する。
- [ ] 意味のあるコメントを追加する。
      - 技術的詳細（「何を」）ではなく意図（「なぜ」）に焦点を当てる。
- [ ] 計画通りにファイルを作成する。
      - ファイル作成ログを文書化する。
- [ ] タスクの進捗状況をリアルタイムで更新する。

**重要な制約:**

- **すべての実装ステップが文書化されテストされるまで、コードをマージまたはデプロイしないこと。**

### **フェーズ4: 検証**

**目的:**

- 実装がすべての要件と品質基準を満たしていることを確認する。

**チェックリスト:**

- [ ] 自動テストを実行する。
    - 出力、ログ、カバレッジレポートを記録する。
    - 失敗時は根本原因分析と修正措置を記録する。
- [ ] 必要に応じて手動検証を実施する。
    - 手順、チェックリスト、結果を記録する。
- [ ] エッジケースとエラーをテストする。
    - 結果と適切なエラー処理の証拠を記録する。
- [ ] パフォーマンスを検証する。
    - メトリクスを記録し、重要セクションをプロファイリングする。
- [ ] 実行トレースをログ記録する。
    - パス解析と実行時挙動を文書化する。

**重要制約:**

- **全ての検証ステップが完了し、全ての問題が解決されるまで進めないこと。**

### **フェーズ5: 振り返り**

**目的:**

- コードベースの改善、ドキュメントの更新、パフォーマンスの分析を行う。

**チェックリスト:**

- [ ] 保守性向上のためのリファクタリングを実施する。
    - 決定事項、前後比較、影響を文書化する。
- [ ] プロジェクト文書を全て更新する。
    - すべてのREADME、図解、コメントが最新であることを確認する。
- [ ] 潜在的な改善点を特定する。
    - 優先順位付けしたバックログを文書化する。
- [ ] 成功基準を検証する。
    - 最終検証マトリクスを文書化する。
- [ ] メタ分析を実施する。
    - 効率性、ツール使用状況、プロトコル遵守状況を振り返る。
- [ ] 技術的負債の課題を自動生成する。
    - インベントリと是正計画を文書化する。

**重要な制約事項：**

- **全てのドキュメントと改善アクションが記録されるまで、フェーズを終了しないこと。**

### **フェーズ6：引き継ぎ**

**目的:**

- レビューとデプロイのための作業をパッケージ化し、次のタスクに移行する。

**チェックリスト:**

- [ ] エグゼクティブサマリーを生成する。
    - **圧縮意思決定記録** フォーマットを使用する。
- [ ] プルリクエストを準備する（該当する場合）:
    1. エグゼクティブサマリー。
    2. **合理化されたアクションログ** からの変更履歴。
    3. 検証成果物および決定記録へのリンク。
    4. 最終版`requirements.md`、`design.md`、`tasks.md`へのリンク。
- [ ] ワークスペースを最終化。
    - 中間ファイル、ログ、一時成果物を`.agent_work/`にアーカイブ。
- [ ] 次タスクへ移行。
    - 移行または完了を文書化。

**重要制約:**

- **全ての引き継ぎステップが完了し文書化されるまで、タスクを完了と見なさないこと。**

## トラブルシューティングと再試行手順

**エラー、曖昧さ、または障害が発生した場合:**

**チェックリスト:**

1. **再分析**:
   - 分析フェーズを再検討する。
   - 全ての要件と制約が明確かつ完全であることを確認する。
2. **再設計**:
   - DESIGNフェーズを再検討する。
   - 必要に応じて技術設計、計画、依存関係を更新する。
3. **再計画**:
   - 新たな発見に対応するため、`tasks.md`の実装計画を調整する。
4. **再実行**:
   - 失敗したステップを修正したパラメータやロジックで再実行する。
5. **エスカレーション**:
   - 再実行後も問題が継続する場合、エスカレーション手順に従う。

**重大な制約事項:**

- **未解決のエラーや曖昧な点を放置して進めてはならない。常にトラブルシューティングの手順と結果を記録すること。**

## 技術的負債管理（自動化）

### 特定と文書化

- **コード品質**: 静的解析を用いて実装中に継続的にコード品質を評価する。
- **ショートカット**: 品質を犠牲にした迅速化判断は、その影響と共に決定記録に明示的に記録する。
- **ワークスペース**: 組織的なドリフトや命名規則の不一致を監視する。
- **ドキュメント**: 不完全、陳腐化、欠落したドキュメントを追跡する。

### 自動課題作成テンプレート

```text
**タイトル**: [技術的負債] - [概要]
**優先度**: [ビジネスへの影響度と修正コストに基づく高/中/低]
**場所**: [ファイルパスと行番号]
**理由**: [負債が発生した原因（可能であれば意思決定記録へのリンク付き）]
**影響**: [現在および将来的な結果（例：開発遅延、バグリスク増加）]
**修正**: [具体的かつ実行可能な解決手順]
**工数**: [解決の見積もり（例：Tシャツサイズ：S、M、L）]
```

### 修正（自動優先順位付け）

- 依存関係分析によるリスクベースの優先順位付け。
- 将来の計画立案を支援する工数見積もり。
- 大規模リファクタリング作業向けの移行戦略提案。

## 品質保証（自動化）

### 継続的モニタリング

- **静的解析**: コードスタイル、品質、セキュリティ脆弱性、アーキテクチャルルールの順守状況に対するリンティング。
- **動的解析**: ステージング環境における実行時動作とパフォーマンスの監視。
- **ドキュメント**: ドキュメントの完全性・正確性（例: リンク、フォーマット）の自動チェック。

### 品質メトリクス（自動追跡）

- コードカバレッジ率とギャップ分析。
- 関数/メソッドごとのサイクロマティック複雑度スコア。
- 保守性指標の評価。
- 技術的負債比率（例: 推定修正時間 vs. 開発時間）。
- ドキュメントカバレッジ率（例：コメント付きパブリックメソッド）。

## EARS表記法リファレンス

**EARS（Easy Approach to Requirements Syntax）** - 要件記述の標準形式：

- **普遍的**: `THE SYSTEM SHALL [期待される動作]`
- **イベント駆動型**: `[トリガーイベント] 発生時、システムは [期待される動作] を行うものとする`
- **状態駆動型**: `[特定の状態] にある間、システムは [期待される動作] を行うものとする`
- **望ましくない動作**: `[望ましくない条件] が発生した場合、システムは [必要な対応] を行うものとする`
- **オプション**: `[機能が包含される場合] システムは [期待される動作] を行うものとする`
- **複合**: 高度な要件のための上記パターンの組み合わせ

各要件は以下を満たす必要がある:

- **テスト可能**: 自動テストまたは手動テストによる検証が可能
- **曖昧さのない**: 単一の解釈が可能
- **必要性**: システムの目的に寄与する
- **実現可能性**: 制約条件内で実装可能
- **追跡可能性**: ユーザーニーズおよび設計要素と関連付けられる
