---
description: 'Guidelines for generating SQL statements and stored procedures'
applyTo: '**/*.sql'
---

# SQL開発

## データベーススキーマ生成
- すべてのテーブル名は単数形とする
- すべての列名は単数形とする
- すべてのテーブルに`id`という名前の主キー列を設ける
- すべてのテーブルに作成時刻を保存する`created_at`列を設ける
- すべてのテーブルに最終更新時刻を保存する`updated_at`列を設ける

## データベーススキーマ設計
- すべてのテーブルに主キー制約を設定すること
- すべての外部キー制約に名前を付けること
- すべての外部キー制約をインラインで定義すること
- すべての外部キー制約に `ON DELETE CASCADE` オプションを設定すること
- すべての外部キー制約に `ON UPDATE CASCADE` オプションを設定すること
- すべての外部キー制約は親テーブルの主キーを参照すること

## SQLコーディングスタイル
- SQLキーワード（SELECT、FROM、WHERE）は大文字で記述
- ネストされたクエリや条件では一貫したインデントを使用
- 複雑なロジックはコメントで説明
- 長いクエリは可読性のために複数行に分割
- 句の順序を統一（SELECT、FROM、JOIN、WHERE、GROUP BY、HAVING、ORDER BY）

## SQLクエリ構造
- SELECT文ではSELECT *ではなく明示的な列名を使用
- 複数テーブルを使用する場合、列名にテーブル名またはエイリアスを付加
- 結合で代替可能な場合はサブクエリの使用を制限
- 結果セットを制限するためLIMIT/TOP句を含める
- 頻繁にクエリされる列には適切なインデックスを適用
- WHERE句でインデックス付き列に対する関数使用を避ける

## ストアドプロシージャ命名規則
- ストアドプロシージャ名に 『usp_』 を接頭辞として付ける
- ストアドプロシージャ名は PascalCase を使用する
- 目的を示す説明的な名前を使用する（例: usp_GetCustomerOrders）
- 複数のレコードを返す場合は複数形の名詞を含める（例: usp_GetProducts）
- 単一のレコードを返す場合は単数形の名詞を含める（例: usp_GetProduct）

## パラメータ処理
- パラメータ名に 『@』 を接頭辞として付ける
- パラメータ名にはキャメルケースを使用する
- オプションパラメータにはデフォルト値を設定する
- 使用前にパラメータ値を検証する
- コメントでパラメータを文書化する
- パラメータを統一的に配置する（必須パラメータを先頭、オプションパラメータを後方に配置）

## ストアドプロシージャの構造
- 説明、パラメータ、戻り値を含むヘッダーコメントブロックを含める
- 標準化されたエラーコード/メッセージを返す
- 一貫した列順で結果セットを返す
- ステータス情報返却にはOUTPUTパラメータを使用する
- 一時テーブルには接頭辞 『tmp_』 を付ける

## SQLセキュリティのベストプラクティス
- SQLインジェクション防止のため全クエリをパラメータ化
- 動的SQL実行時はプリペアドステートメントを使用
- SQLスクリプトへの認証情報埋め込みを回避
- システム詳細を漏洩しない適切なエラー処理を実装
- ストアドプロシージャ内での動的SQL使用を回避

## トランザクション管理
- トランザクションの明示的な開始とコミット
- 要件に基づいた適切な分離レベルの使用
- テーブルをロックする長期実行トランザクションの回避
- 大規模データ操作にはバッチ処理を使用
- データを変更するストアドプロシージャにはSET NOCOUNT ONを含める
